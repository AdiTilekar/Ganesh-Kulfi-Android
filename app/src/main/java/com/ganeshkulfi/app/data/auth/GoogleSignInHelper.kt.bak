package com.ganeshkulfi.app.data.auth

import android.content.Context
import android.content.Intent
import android.content.IntentSender
import com.ganeshkulfi.app.R
import com.google.android.gms.auth.api.identity.BeginSignInRequest
import com.google.android.gms.auth.api.identity.Identity
import com.google.android.gms.auth.api.identity.SignInClient
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.auth.FirebaseUser
import com.google.firebase.auth.GoogleAuthProvider
import com.google.firebase.auth.ktx.auth
import com.google.firebase.ktx.Firebase
import kotlinx.coroutines.tasks.await
import javax.inject.Inject
import javax.inject.Singleton

/**
 * Google Sign-In helper using Firebase Authentication
 * Handles OAuth flow with Google Identity Services
 */
@Singleton
class GoogleSignInHelper @Inject constructor(
    private val context: Context
) {
    private val auth: FirebaseAuth = Firebase.auth
    private lateinit var oneTapClient: SignInClient
    private lateinit var signInRequest: BeginSignInRequest
    
    // TODO: Replace with your actual Web Client ID from Firebase Console
    // Get this from: Firebase Console → Project Settings → General → Web API Key
    private val webClientId = "YOUR_WEB_CLIENT_ID_HERE.apps.googleusercontent.com"
    
    init {
        setupGoogleSignIn()
    }
    
    private fun setupGoogleSignIn() {
        oneTapClient = Identity.getSignInClient(context)
        
        signInRequest = BeginSignInRequest.builder()
            .setGoogleIdTokenRequestOptions(
                BeginSignInRequest.GoogleIdTokenRequestOptions.builder()
                    .setSupported(true)
                    .setServerClientId(webClientId)
                    .setFilterByAuthorizedAccounts(false) // Show all Google accounts
                    .build()
            )
            .setAutoSelectEnabled(true) // Auto-select if only one account
            .build()
    }
    
    /**
     * Initiates Google Sign-In flow
     * Returns IntentSender to launch sign-in UI
     */
    suspend fun signIn(): IntentSender? {
        return try {
            val result = oneTapClient.beginSignIn(signInRequest).await()
            result.pendingIntent.intentSender
        } catch (e: Exception) {
            e.printStackTrace()
            null
        }
    }
    
    /**
     * Handles the sign-in result from Google
     * Returns FirebaseUser if successful, null otherwise
     */
    suspend fun handleSignInResult(intent: Intent): Result<FirebaseUser> {
        return try {
            val credential = oneTapClient.getSignInCredentialFromIntent(intent)
            val googleIdToken = credential.googleIdToken
            
            if (googleIdToken == null) {
                return Result.failure(Exception("Google ID token is null"))
            }
            
            // Authenticate with Firebase
            val firebaseCredential = GoogleAuthProvider.getCredential(googleIdToken, null)
            val authResult = auth.signInWithCredential(firebaseCredential).await()
            val firebaseUser = authResult.user
            
            if (firebaseUser != null) {
                Result.success(firebaseUser)
            } else {
                Result.failure(Exception("Firebase user is null"))
            }
        } catch (e: Exception) {
            e.printStackTrace()
            Result.failure(e)
        }
    }
    
    /**
     * Signs out the current user
     */
    suspend fun signOut() {
        try {
            auth.signOut()
            oneTapClient.signOut().await()
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }
    
    /**
     * Gets currently signed-in user
     */
    fun getCurrentUser(): FirebaseUser? {
        return auth.currentUser
    }
    
    /**
     * Gets user's email
     */
    fun getUserEmail(): String? {
        return auth.currentUser?.email
    }
    
    /**
     * Gets user's display name
     */
    fun getUserDisplayName(): String? {
        return auth.currentUser?.displayName
    }
    
    /**
     * Gets user's photo URL
     */
    fun getUserPhotoUrl(): String? {
        return auth.currentUser?.photoUrl?.toString()
    }
}

/**
 * Result wrapper for sign-in operations
 */
sealed class SignInResult {
    data class Success(val user: FirebaseUser) : SignInResult()
    data class Error(val message: String) : SignInResult()
    object Cancelled : SignInResult()
}
